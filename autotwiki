#!/usr/bin/python

import os
import re
import sys
import json
import mechanize
from datetime import (datetime, date, timedelta)

def week_string(dt):
    (year, week, weekday) = dt.isocalendar()
    week_0 = dt - timedelta(days=weekday)
    week_1 = dt + timedelta(days=(6-weekday))

    month_0 = week_0.strftime("%b")
    day_0 = week_0.strftime("%e").strip()
    year_0 = week_0.strftime("%Y")

    month_1 = week_1.strftime("%b")
    day_1 = week_1.strftime("%e").strip()
    year_1 = week_1.strftime("%Y")

    if year_0 != year_1:
        return "%s %s, %s - %s %s, %s" %(
            month_0, day_0, year_0,
            month_1, day_1, year_1)
    elif month_0 != month_1:
        return "%s %s - %s %s, %s" %(
            month_0, day_0,
            month_1, day_1, year_1)
    else:
        return "%s %s - %s, %s" %(
            month_0, day_0, day_1, year_1)

# Configuration
config_filename = os.path.expanduser('~/.config/autotwiki/config.json')
with open(config_filename, 'r') as f:
    config = json.load(f)

domain = config['domain']
username = config['username']
password = config['password']
team = config['team']

# Calculate the current week
today = datetime.date(datetime.now())
(year, week, weekday) = today.isocalendar()

# Browser
br = mechanize.Browser()

# Debugging
# br.set_debug_http(True)
# br.set_debug_redirects(True)
# br.set_debug_responses(True)

# Credentials
br.add_password(domain, username, password)

url = "%s/bin/edit/%s/%sWeek%02dStatus%d" %(
    domain, team, username, week, year)
r = br.open(url)

# Select the first (index zero) form
br.select_form(nr=0)

text = br.form['text']
if len(text) < 100:
    # Topic looks like it hasn't been created yet
    config_filename = os.path.expanduser(config['status-template'])
    with open(config_filename, 'r') as f:
        text = f.read()

text = re.sub('\[\[full-name\]\]', username, text)
text = re.sub('\[\[week-number\]\]', str(week), text)
text = re.sub('\[\[week-string\]\]', week_string(today), text)

text = re.sub(r'<li> Patches submitted: \d+ \(\d+ this year\)<\/li>',
              "<li> Patches submitted: %d (%d this year)</li>" %(
              1, 2), text)

text = re.sub(r'<li> Patches landed: \d+ \(\d+ this year\)<\/li>',
              "<li> Patches landed: %d (%d this year)</li>" %(
              3, 4), text)

text = re.sub(r'<li> Patches reviewed: \d+ \(\d+ this year\)<\/li>',
              "<li> Patches reviewed: %d (%d this year)</li>" %(
              5, 6), text)

text = re.sub(r'<li> Bugs reported: \d+ \(\d+ this year\)<\/li>',
              "<li> Bugs reported: %d (%d this year)</li>" %(
              7, 8), text)

text = re.sub(r'<li> Bugs fixed: \d+ \(\d+ this year\)<\/li>',
              "<li> Bugs fixed: %d (%d this year)</li>" %(
              9, 10), text)

br.form['text'] = text
br.submit()
print br.response().read()

#orig_html = r.read()
#new_html = orig_html.replace("> Development <", "> Development - 42 Patches <")
